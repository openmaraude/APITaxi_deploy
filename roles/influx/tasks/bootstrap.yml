---

- name: Install python3-influxdb
  apt:
    name:
      - python3-influxdb

- name: Check if admin user already exists
  shell: influx -username {{ influx.admin_username }} -password {{ influx.admin_password }} -execute 'SHOW USERS' 2>/dev/null >/dev/null && echo "yes" || echo "no"
  ignore_errors: true
  register: influx_admin_exists_command

- set_fact:
    influx_admin_exists: "{{ influx_admin_exists_command.stdout_lines|join('') == 'yes' }}"
  when: not ansible_check_mode

# Always set to true when --check is provided
- set_fact:
    influx_admin_exists: true
  when: ansible_check_mode

# Disable authentication
- name: Disable influxdb authentication
  template:
    src: templates/influxdb.conf.j2
    dest: /etc/influxdb/influxdb.conf
  vars:
    influx:
      auth_enabled: false
  register: influxdb_conf
  when: not influx_admin_exists

# Restart influxdb and wait_for it to be ready to accept connections if
# authentication was not already disabled
- name: Force restart influxdb
  service:
    name: influxdb
    state: restarted
  when: not influx_admin_exists and influxdb_conf.changed

- name: Wait for port 8086 to become open
  wait_for:
    port: 8086
    delay: 5
  when: not influx_admin_exists and influxdb_conf.changed

- name: Create database
  influxdb_database:
    login_username: "{{ influx.admin_username }}"
    login_password: "{{ influx.admin_password }}"
    database_name: taxis_prod

- name: Create admin user
  influxdb_user:
    user_name: "{{ influx.admin_username }}"
    user_password: "{{ influx.admin_password }}"
    admin: yes
  when: not influx_admin_exists

- name: Create API user
  influxdb_user:
    login_username: "{{ influx.admin_username }}"
    login_password: "{{ influx.admin_password }}"
    user_name: "{{ influx.api_username }}"
    user_password: "{{ influx.api_password }}"

    grants:
      - database: 'taxis_prod'
        privilege: 'ALL'

- name: Restore influxdb authentication
  template:
    src: templates/influxdb.conf.j2
    dest: /etc/influxdb/influxdb.conf
  notify: Restart influxdb
